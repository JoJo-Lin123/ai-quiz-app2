<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>AI 測驗小程式</title>
<style>
  body {
    font-family: "Noto Sans", "Microsoft JhengHei", sans-serif;
    background: #e3f2fd;
    margin: 0; padding: 20px;
    color: #222;
  }
  .container {
    max-width: 720px;
    margin: 0 auto;
    background: #fff;
    border-radius: 12px;
    box-shadow: 0 6px 12px rgb(0 0 0 / 0.1);
    padding: 24px;
  }
  h2, h3 {
    color: #1565c0;
  }
  button {
    background: #42a5f5;
    border: none;
    color: white;
    padding: 10px 16px;
    margin: 4px;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 500;
    font-size: 14px;
    transition: background-color 0.3s ease;
  }
  button:hover {
    background: #1e88e5;
  }
  button.outline {
    background: none;
    border: 2px solid #42a5f5;
    color: #42a5f5;
  }
  button.outline:hover {
    background: #bbdefb;
  }
  button.outline.red {
    border-color: #e57373;
    color: #e57373;
  }
  button.outline.red:hover {
    background: #ffcdd2;
  }
  button.disabled {
    background: #90caf9;
    cursor: default;
  }
  .question {
    font-size: 18px;
    margin-bottom: 16px;
    font-weight: 500;
  }
  .options button {
    width: 100%;
    text-align: left;
    margin-bottom: 8px;
    font-weight: normal;

    background: #bbdefb;
    color: #1565c0;
    font-weight: 500;
  }
  .options button:hover:not(.selected):not(.correct):not(.wrong) {
    background: #90caf9;
  }
  .options button.selected {
    background: #90caf9;
  }
  .options button.correct {
    background: #a5d6a7;
    color: #2e7d32;
    font-weight: 600;
  }
  .options button.wrong {
    background: #ef9a9a;
    color: #b71c1c;
    font-weight: 600;
  }
  .explanation {
    margin-top: 12px;
    font-size: 14px;
    color: #555;
    padding: 12px;
    background: #f1f8e9;
    border-radius: 8px;
    border: 1px solid #c5e1a5;
  }
  .btn-group {
    margin-top: 20px;
    display: flex;
    justify-content: center;
    gap: 12px;
    flex-wrap: wrap;
  }
  .timer {
    font-size: 14px;
    color: #666;
    margin-bottom: 12px;
    text-align: right;
  }
  .card {
    border: 1px solid #bbdefb;
    border-radius: 10px;
    background: #e3f2fd;
    padding: 16px;
    margin-bottom: 20px;
  }
  input[type=text], input[type=number], textarea {
    width: 100%;
    box-sizing: border-box;
    padding: 8px;
    margin-bottom: 10px;
    border: 1px solid #90caf9;
    border-radius: 6px;
    font-size: 14px;
    font-family: inherit;
  }
  label {
    font-weight: 600;
    margin-bottom: 4px;
    display: block;
    color: #1565c0;
  }
  .list-item {
    border-bottom: 1px solid #bbdefb;
    padding: 10px 0;
    display: flex;
    align-items: center;
    justify-content: space-between;
  }
  .list-item:last-child {
    border-bottom: none;
  }
  .list-item > .info {
    flex: 1;
    padding-right: 12px;
    font-weight: 500;
  }
  .list-item > .btns {
    display: flex;
    gap: 8px;
  }
  .flex-row {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
  }
  .flex-row button {
    flex: 1 1 120px;
  }
  .small-text {
    font-size: 12px;
    color: #444;
  }
  .error-list, .score-history {
    max-height: 300px;
    overflow-y: auto;
  }
  .error-item, .score-item {
    border: 1px solid #90caf9;
    background: #e3f2fd;
    margin-bottom: 10px;
    padding: 10px;
    border-radius: 6px;
  }
  .error-item h4, .score-item h4 {
    margin: 0 0 6px 0;
    color: #1e88e5;
  }
  /* 錯誤答案與正確答案樣式 */
  .wrong-answer {
    background:#ffd7d9; color:#d32f2f; padding:2px 6px; border-radius:4px;
  }
  .correct-answer {
    background:#a5d6a7; color:#388e3c; font-weight:700; padding:2px 6px; border-radius:4px;
  }
</style>
</head>
<body>
  <div class="container">
    <h2>AI 測驗小程式</h2>

    <div id="main-content">載入題庫中，請稍候...</div>

    <div class="btn-group" id="main-buttons">
      <button id="btnRestart">重新測驗</button>
      <button id="btnViewScore">查看成績</button>
      <button id="btnManage">題庫管理</button>
    </div>
  </div>

<script>
(() => {
  const csvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQRjSIaWiqOgdH2nNgcvcJ8Sff9Ivii3pAQFolIR7fKxT5MTjK783-w_gEllWkYwzuQznZyKtvyKROn/pub?output=csv";

  async function loadQuizData() {
    try {
      const res = await fetch(csvUrl);
      const text = await res.text();
      const rows = text.trim().split("\n").map(line => line.split(/,(?=(?:[^"]*"[^"]*")*[^"]*$)/));
      const header = rows[0].map(h => h.trim().toLowerCase());
      const dataRows = rows.slice(1);

      return dataRows.map(row => {
        const obj = {};
        header.forEach((key, i) => {
          obj[key] = row[i]?.replace(/^"|"$/g, '').trim();
        });
        return {
          category: obj.category || '',
          question: obj.question || '',
          options: [obj.option1, obj.option2, obj.option3, obj.option4].filter(Boolean),
          answer: parseInt(obj.answer, 10),
          explanation: obj.explanation || ''
        };
      });
    } catch (e) {
      alert("題庫載入失敗，請稍後再試。");
      console.error(e);
      return null;
    }
  }

  let quizData = [
    {
      category: "語言處理",
      question: "詞幹提取與詞形還原的差異為何？",
      options: [
        "詞幹提取比詞形還原更精確",
        "詞幹提取保留完整語意",
        "詞幹提取是簡單截斷字尾，詞形還原考慮語法與詞彙表",
        "兩者沒有差異"
      ],
      answer: 2,
      explanation: "詞幹提取（Stemming）透過規則刪除字尾，無法處理語意；詞形還原（Lemmatization）使用語法規則與詞彙表還原成字典型。"
    },
    {
      category: "機器學習",
      question: "以下何者最容易造成過擬合？",
      options: [
        "使用大量資料訓練簡單模型",
        "模型太簡單",
        "模型太複雜且資料太少",
        "使用標準化資料"
      ],
      answer: 2,
      explanation: "過擬合通常發生在模型太複雜且訓練資料不足的情況下，導致學會訓練集的雜訊而非通則。"
    }
  ];

  // Local storage 相關
  let scoreHistory = JSON.parse(localStorage.getItem("scoreHistory")) || [];
  let current = 0;
  let selected = null;
  let showResult = false;
  let score = 0;
  let completed = false;
  let timer = 30;
  let timerInterval = null;
  let mode = "quiz";
  let editingIndex = null;
  let editingData = null;
  let currentWrongAnswers = [];

  const mainContent = document.getElementById("main-content");
  const btnRestart = document.getElementById("btnRestart");
  const btnViewScore = document.getElementById("btnViewScore");
  const btnManage = document.getElementById("btnManage");

  // 儲存題庫到 localStorage
  function saveData() {
    localStorage.setItem("quizData", JSON.stringify(quizData));
  }
  // 儲存成績歷史
  function saveScores() {
    localStorage.setItem("scoreHistory", JSON.stringify(scoreHistory));
  }

  // 計時器相關
  function startTimer() {
    clearInterval(timerInterval);
    timer = 30;
    updateTimerUI();
    timerInterval = setInterval(() => {
      timer--;
      updateTimerUI();
      if (timer <= 0) {
        clearInterval(timerInterval);
        if (!showResult && !completed) handleAnswer(-1);
      }
    }, 1000);
  }
  function updateTimerUI() {
    const timerDiv = document.getElementById("timer");
    if (timerDiv) timerDiv.textContent = `倒數計時：${timer} 秒`;
  }

  // 渲染題目畫面
  function renderQuiz() {
    mode = "quiz";
    if (current >= quizData.length) {
      completed = true;
      renderResult();
      return;
    }
    const q = quizData[current];

    let html = `<div class="timer" id="timer">倒數計時：${timer} 秒</div>`;
    html += `<h3>${q.category}</h3>`;
    html += `<div class="question">${q.question}</div>`;
    html += `<div class="options">`;
    q.options.forEach((opt, i) => {
      let btnClass = "";
      if (showResult) {
        if (i === q.answer) btnClass = "correct";
        else if (i === selected && i !== q.answer) btnClass = "wrong";
      } else if (i === selected) {
        btnClass = "selected";
      }
      html += `<button class="${btnClass}" data-index="${i}">${opt}</button>`;
    });
    html += `</div>`;

    if (showResult) {
      html += `<div class="explanation">${q.explanation}</div>`;
      html += `<button id="btnNext">${current + 1 < quizData.length ? "下一題" : "查看結果"}</button>`;
    }
    mainContent.innerHTML = html;

    if (!showResult) startTimer();

    // 綁定選項按鈕事件
    document.querySelectorAll(".options button").forEach(btn => {
      btn.addEventListener("click", () => {
        if (showResult) return;
        const idx = parseInt(btn.getAttribute("data-index"));
        handleAnswer(idx);
      });
    });

    // 下一題按鈕事件
    const btnNext = document.getElementById("btnNext");
    if (btnNext) {
      btnNext.addEventListener("click", () => {
        if (!showResult) return;
        selected = null;
        showResult = false;
        current++;
        renderQuiz();
      });
    }
  }

  // 答題處理
  function handleAnswer(idx) {
    if (showResult) return;
    selected = idx;
    showResult = true;
    clearInterval(timerInterval);

    const q = quizData[current];
    if (idx === q.answer) {
      score++;
    } else {
      currentWrongAnswers.push({
        index: current,
        question: q.question,
        yourAnswer: idx >= 0 ? q.options[idx] : "無回答",
        correctAnswer: q.options[q.answer]
      });
    }
    renderQuiz();
  }

  // 顯示測驗結果
  function renderResult() {
    mode = "result";
    let html = `<h3>測驗結束！</h3>`;
    html += `<p>您的得分：${score} / ${quizData.length}</p>`;

    // 紀錄錯誤題目
    if (currentWrongAnswers.length > 0) {
      html += `<h4>錯誤題目：</h4><ul>`;
      currentWrongAnswers.forEach(item => {
        html += `<li><strong>${item.question}</strong><br>
          您答：<span class="wrong-answer">${item.yourAnswer}</span> ，
          正確答案：<span class="correct-answer">${item.correctAnswer}</span>
        </li>`;
      });
      html += `</ul>`;
    } else {
      html += `<p>恭喜全部答對！</p>`;
    }

    html += `<button id="btnSaveScore">儲存成績</button>`;
    html += `<button id="btnRestart2">重新測驗</button>`;
    html += `<button id="btnViewScore2">查看成績</button>`;
    html += `<button id="btnManage2">題庫管理</button>`;

    mainContent.innerHTML = html;

    document.getElementById("btnSaveScore").addEventListener("click", () => {
      const now = new Date().toISOString();
      scoreHistory.push({ date: now, score: score, total: quizData.length });
      saveScores();
      alert("成績已儲存！");
    });
    document.getElementById("btnRestart2").addEventListener("click", () => {
      resetQuiz();
    });
    document.getElementById("btnViewScore2").addEventListener("click", () => {
      renderScoreHistory();
    });
    document.getElementById("btnManage2").addEventListener("click", () => {
      renderManage();
    });
  }

  // 重設測驗
  function resetQuiz() {
    current = 0;
    selected = null;
    showResult = false;
    score = 0;
    completed = false;
    currentWrongAnswers = [];
    startTimer();
    renderQuiz();
  }

  // 顯示成績歷史
  function renderScoreHistory() {
    mode = "scoreHistory";
    let html = `<h3>成績紀錄</h3>`;
    if (scoreHistory.length === 0) {
      html += `<p>尚無成績紀錄。</p>`;
    } else {
      html += `<div class="score-history">`;
      scoreHistory.forEach((rec, i) => {
        html += `<div class="score-item">
          <h4>第 ${i + 1} 次測驗</h4>
          <p>日期：${rec.date.slice(0, 10)}<br>得分：${rec.score} / ${rec.total}</p>
        </div>`;
      });
      html += `</div>`;
    }
    html += `<button id="btnBackToQuiz">回到測驗</button>`;
    html += `<button id="btnManageFromScore">題庫管理</button>`;

    mainContent.innerHTML = html;

    document.getElementById("btnBackToQuiz").addEventListener("click", () => {
      resetQuiz();
    });
    document.getElementById("btnManageFromScore").addEventListener("click", () => {
      renderManage();
    });
  }

  // 題庫管理介面
  function renderManage() {
    mode = "manage";
    let html = `<h3>題庫管理</h3>`;

    if (quizData.length === 0) {
      html += `<p>題庫目前沒有題目。</p>`;
    } else {
      html += `<div class="error-list">`;
      quizData.forEach((q, i) => {
        html += `<div class="list-item">
          <div class="info">
            <strong>${q.category}</strong>：${q.question}
          </div>
          <div class="btns">
            <button class="outline" data-edit="${i}">編輯</button>
            <button class="outline red" data-del="${i}">刪除</button>
          </div>
        </div>`;
      });
      html += `</div>`;
    }
    html += `<button id="btnAddNew">新增題目</button>`;
    html += `<button id="btnBackToQuiz2">回到測驗</button>`;
    html += `<button id="btnViewScore3">查看成績</button>`;

    mainContent.innerHTML = html;

    document.getElementById("btnAddNew").addEventListener("click", () => {
      editingIndex = null;
      editingData = null;
      renderEdit();
    });
    document.getElementById("btnBackToQuiz2").addEventListener("click", () => {
      resetQuiz();
    });
    document.getElementById("btnViewScore3").addEventListener("click", () => {
      renderScoreHistory();
    });

    document.querySelectorAll("[data-edit]").forEach(btn => {
      btn.addEventListener("click", e => {
        const idx = parseInt(e.target.getAttribute("data-edit"));
        editingIndex = idx;
        editingData = quizData[idx];
        renderEdit();
      });
    });
    document.querySelectorAll("[data-del]").forEach(btn => {
      btn.addEventListener("click", e => {
        const idx = parseInt(e.target.getAttribute("data-del"));
        if (confirm("確定要刪除這題嗎？")) {
          quizData.splice(idx, 1);
          saveData();
          renderManage();
        }
      });
    });
  }

  // 編輯或新增題目
  function renderEdit() {
    mode = "edit";
    const d = editingData || {
      category: '',
      question: '',
      option1: '',
      option2: '',
      option3: '',
      option4: '',
      answer: 0,
      explanation: ''
    };

    let html = `<h3>${editingIndex !== null ? "編輯題目" : "新增題目"}</h3>`;
    html += `<form id="editForm">
      <label>分類</label>
      <input type="text" name="category" value="${d.category}" required />

      <label>題目</label>
      <textarea name="question" rows="3" required>${d.question}</textarea>

      <label>選項 1</label>
      <input type="text" name="option1" value="${d.option1 || d.options?.[0] || ''}" required />

      <label>選項 2</label>
      <input type="text" name="option2" value="${d.option2 || d.options?.[1] || ''}" required />

      <label>選項 3</label>
      <input type="text" name="option3" value="${d.option3 || d.options?.[2] || ''}" />

      <label>選項 4</label>
      <input type="text" name="option4" value="${d.option4 || d.options?.[3] || ''}" />

      <label>正確答案（填選項編號，0 起算）</label>
      <input type="number" name="answer" min="0" max="3" value="${d.answer}" required />

      <label>說明（可選）</label>
      <textarea name="explanation" rows="2">${d.explanation}</textarea>

      <div class="btn-group" style="justify-content:center; margin-top: 12px;">
        <button type="submit">儲存</button>
        <button type="button" id="btnCancelEdit" class="outline red">取消</button>
      </div>
    </form>`;

    mainContent.innerHTML = html;

    const form = document.getElementById("editForm");
    form.addEventListener("submit", e => {
      e.preventDefault();
      const formData = new FormData(form);
      const newQ = {
        category: formData.get("category").trim(),
        question: formData.get("question").trim(),
        options: [
          formData.get("option1").trim(),
          formData.get("option2").trim(),
          formData.get("option3").trim(),
          formData.get("option4").trim(),
        ].filter(opt => opt.length > 0),
        answer: Number(formData.get("answer")),
        explanation: formData.get("explanation").trim()
      };
      if (newQ.answer < 0 || newQ.answer >= newQ.options.length) {
        alert("正確答案的編號必須對應現有選項。");
        return;
      }

      if (editingIndex !== null) {
        quizData[editingIndex] = newQ;
      } else {
        quizData.push(newQ);
      }
      saveData();
      editingIndex = null;
      editingData = null;
      renderManage();
    });

    document.getElementById("btnCancelEdit").addEventListener("click", () => {
      editingIndex = null;
      editingData = null;
      renderManage();
    });
  }

  // 初始化程式
  async function init() {
    const data = await loadQuizData();
    if (data && data.length > 0) {
      quizData = data;
      saveData();
    } else {
      // 若無法從 Google Sheets 載入，嘗試讀 localStorage
      const localData = localStorage.getItem("quizData");
      if (localData) {
        try {
          quizData = JSON.parse(localData);
        } catch {}
      }
    }
    resetQuiz();
  }

  // 按鈕事件
  btnRestart.addEventListener("click", () => {
    resetQuiz();
  });
  btnViewScore.addEventListener("click", () => {
    renderScoreHistory();
  });
  btnManage.addEventListener("click", () => {
    renderManage();
  });

  // 執行初始化
  init();

})();
</script>

</body>
</html>
